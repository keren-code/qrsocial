<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Escáner QR - Sonica</title>

  <!-- html5-qrcode (escaneo) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <!-- jsPDF (export PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:16px; background:#0f172a; color:#e6eef8;}
    .container{max-width:980px;margin:0 auto;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); padding:16px; border-radius:12px; box-shadow:0 4px 18px rgba(2,6,23,0.6);}
    h1{margin:0 0 8px 0;font-size:20px}
    label{display:block;margin-top:8px;font-size:13px}
    input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;width:100%}
    button{margin-top:8px;padding:10px 12px;border-radius:10px;border:0;background:#06b6d4;color:#041124;cursor:pointer;font-weight:600}
    .muted{color:#99a3b5;font-size:13px}
    #reader{width:100%;min-height:320px;border-radius:10px;overflow:hidden;background:#000;position:relative;}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .status-unique{color:#10b981;font-weight:700}
    .status-dup{color:#ef4444;font-weight:800}
    .type-cover{background:#222C3A;color:#ffd; padding:4px 8px;border-radius:8px;display:inline-block}
    .type-entrada{background:#122a2f;color:#dff; padding:4px 8px;border-radius:8px;display:inline-block}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .small{font-size:12px;padding:6px 8px}
    .log-message{padding:8px;border-radius:8px;margin-top:8px}
    .log-dup{background:rgba(239,68,68,0.12);color:#fff}
    .log-ok{background:rgba(16,185,129,0.08);color:#eafff5}
    .loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;color:white;font-size:18px;flex-direction:column;}
    .loading-spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#06b6d4;animation:spin 1s linear infinite;margin-bottom:16px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .camera-error{background:rgba(239,68,68,0.1);padding:16px;border-radius:8px;margin-top:12px;text-align:center;}
    .retry-btn{margin-top:12px;}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Escáner QR — Sonica</h1>
      <p class="muted">Usuario: <strong>sonica</strong> — Contraseña: <strong>232323</strong></p>

      <!-- Login -->
      <div id="loginBox">
        <label>Usuario</label>
        <input id="username" placeholder="usuario" autocomplete="username">
        <label>Contraseña</label>
        <input id="password" placeholder="contraseña" type="password" autocomplete="current-password">
        <div class="controls">
          <button id="loginBtn">Iniciar sesión</button>
          <button id="loginDemo" class="small">Autocompletar (sonica)</button>
        </div>
      </div>

      <!-- Scanner area -->
      <div id="scannerArea" style="display:none">
        <div id="reader">
          <div id="cameraLoading" class="loading-overlay" style="display:none;">
            <div class="loading-spinner"></div>
            <div>Iniciando cámara...</div>
          </div>
          <div id="cameraError" class="camera-error" style="display:none;">
            <h3>Error al acceder a la cámara</h3>
            <p>Asegúrate de dar los permisos necesarios y que ninguna otra aplicación esté usando la cámara.</p>
            <button id="retryCamera" class="retry-btn">Reintentar</button>
          </div>
        </div>

        <div class="controls">
          <button id="startCam">Abrir cámara</button>
          <button id="stopCam" disabled>Detener cámara</button>
          <button id="clearHistory" class="small">Borrar historial</button>
          <button id="exportPdf" class="small">Descargar PDF</button>
          <button id="toggleSound" class="small">Sonido: ON</button>
          <button id="logoutBtn" class="small">Cerrar sesión</button>
        </div>

        <div id="lastLog" style="margin-top:10px"></div>

        <h3 style="margin-top:14px">Historial de escaneos</h3>
        <table id="historyTable">
          <thead>
            <tr><th>#</th><th>Tipo</th><th>Número / Texto</th><th>Hora</th><th>Estado</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const AUTH_USER = 'sonica';
const AUTH_PASS = '232323';

const STORAGE_KEY = 'sonica_scanner_history_v1';
const SET_KEY = 'sonica_scanner_seen_set_v1';
const SESSION_KEY = 'sonica_scanner_session_v1';
let seenSet = new Set();
let history = [];
let html5Scanner = null;
let scanning = false;
let soundOn = true;
let currentCameraId = null;

const loginBox = document.getElementById('loginBox');
const scannerArea = document.getElementById('scannerArea');
const loginBtn = document.getElementById('loginBtn');
const loginDemo = document.getElementById('loginDemo');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const startCamBtn = document.getElementById('startCam');
const stopCamBtn = document.getElementById('stopCam');
const clearHistoryBtn = document.getElementById('clearHistory');
const exportPdfBtn = document.getElementById('exportPdf');
const lastLog = document.getElementById('lastLog');
const historyTableBody = document.querySelector('#historyTable tbody');
const toggleSoundBtn = document.getElementById('toggleSound');
const logoutBtn = document.getElementById('logoutBtn');
const cameraLoading = document.getElementById('cameraLoading');
const cameraError = document.getElementById('cameraError');
const retryCameraBtn = document.getElementById('retryCamera');

// -------- Persistencia ----------
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  localStorage.setItem(SET_KEY, JSON.stringify(Array.from(seenSet)));
}

function saveSessionState() {
  const sessionData = {
    loggedIn: true,
    cameraActive: scanning,
    cameraId: currentCameraId,
    soundOn: soundOn
  };
  localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
}

function loadState(){
  try{
    history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    seenSet = new Set(JSON.parse(localStorage.getItem(SET_KEY) || '[]'));
    
    // Cargar estado de sesión
    const sessionData = JSON.parse(localStorage.getItem(SESSION_KEY) || '{}');
    if (sessionData.loggedIn) {
      // Ocultar login y mostrar scanner
      loginBox.style.display = 'none';
      scannerArea.style.display = 'block';
      
      // Restaurar configuración de sonido
      soundOn = sessionData.soundOn !== undefined ? sessionData.soundOn : true;
      toggleSoundBtn.innerText = `Sonido: ${soundOn ? "ON" : "OFF"}`;
      
      // Si la cámara estaba activa, intentar reconectar
      if (sessionData.cameraActive) {
        currentCameraId = sessionData.cameraId;
        setTimeout(() => {
          startCamera(true); // true = reconexión automática
        }, 800);
      } else {
        renderHistory();
      }
    }
  } catch(e) { 
    console.error("Error loading state:", e);
    history = []; 
    seenSet = new Set(); 
  }
}

function clearSessionState() {
  localStorage.removeItem(SESSION_KEY);
}

// -------- Utilidades ----------
function formatDate(ts){ return new Date(ts).toLocaleString(); }
function vibrate(ms=200){ if(navigator.vibrate) navigator.vibrate(ms); }
function beep(){
  if(!soundOn) return;
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=880;
    o.connect(g); g.connect(ctx.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.12);
    setTimeout(()=>{o.stop();ctx.close();},160);
  }catch{}
}
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;'); }

// -------- Parse QR ----------
function parseQRText(text){
  const t = (text||"").trim();
  let tipo="ENTRADA", numero=null;
  if(/cover/i.test(t)) tipo="COVER";
  if(/\bentrada\b/i.test(t)||/\bentr/i.test(t)) tipo="ENTRADA";
  let m = t.match(/(?:cover|entrada|entr)?[:\-\s]*#?(\d{1,10})/i);
  if(m) numero=m[1];
  if(!numero && /^\d+$/.test(t)){numero=t; tipo="ENTRADA";}
  if(!numero) numero=t.length>40?t.slice(0,40)+'...':t;
  return {tipo,numero,raw:t};
}

// -------- Render ----------
function renderHistory(){
  historyTableBody.innerHTML='';
  history.forEach((item,i)=>{
    historyTableBody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${item.tipo==='COVER'
          ?'<span class="type-cover">COVER</span>'
          :'<span class="type-entrada">ENTRADA</span>'}</td>
        <td>${escapeHtml(item.numero)}</td>
        <td>${formatDate(item.ts)}</td>
        <td class="${item.duplicado?'status-dup':'status-unique'}">${item.duplicado?'DOBLE':'ÚNICO'}</td>
      </tr>`;
  });
}
function showLog(msg,dup=false){
  lastLog.innerHTML=`<div class="log-message ${dup?'log-dup':'log-ok'}">${msg}</div>`;
}

// -------- Manejo escaneo ----------
function onDecodedText(decodedText){
  const p=parseQRText(decodedText);
  const key=`${p.tipo}::${p.numero}`;
  const isDup=seenSet.has(key);
  const entry={...p, ts:Date.now(), duplicado:isDup};
  history.unshift(entry);
  if(!isDup){ seenSet.add(key); showLog(`OK — ${p.tipo} ${p.numero}`); beep();}
  else{ showLog(`DUPLICADO — ${p.tipo} ${p.numero}`,true); vibrate(250);}
  saveState(); renderHistory();
}

// -------- Cámara ----------
async function startCamera(isReconnecting = false){
  if(scanning) return;
  
  // Mostrar indicador de carga y ocultar errores
  cameraLoading.style.display = 'flex';
  cameraError.style.display = 'none';
  
  html5Scanner = new Html5Qrcode("reader", {verbose: false});
  const config = {fps: 15, qrbox: {width: 250, height: 250}};
  
  try {
    const devices = await Html5Qrcode.getCameras();
    if (devices.length) {
      let camId;
      
      // Priorizar la cámara usada previamente si está disponible
      if (currentCameraId) {
        const previousCamera = devices.find(d => d.id === currentCameraId);
        if (previousCamera) {
          camId = previousCamera.id;
        } else {
          // Usar la cámara trasera por defecto si está disponible
          const backCamera = devices.find(d => d.label.toLowerCase().includes('back'));
          camId = backCamera ? backCamera.id : devices[0].id;
        }
      } else {
        // Usar la cámara trasera por defecto si está disponible
        const backCamera = devices.find(d => d.label.toLowerCase().includes('back'));
        camId = backCamera ? backCamera.id : devices[0].id;
      }
      
      currentCameraId = camId;
      await html5Scanner.start({deviceId: {exact: camId}}, config, onDecodedText);
      scanning = true;
      startCamBtn.disabled = true; 
      stopCamBtn.disabled = false;
      
      // Guardar estado de sesión
      saveSessionState();
      
      // Ocultar indicador de carga
      cameraLoading.style.display = 'none';
      
      showLog("✅ Cámara abierta. Escanea un QR.");
    } else {
      cameraLoading.style.display = 'none';
      cameraError.style.display = 'block';
      showLog("❌ No se encontraron cámaras.", true);
    }
  } catch(err) { 
    console.error("Camera error:", err); 
    cameraLoading.style.display = 'none';
    cameraError.style.display = 'block';
    showLog("⚠️ Error al abrir cámara: " + err.message, true);
    scanning = false;
    startCamBtn.disabled = false; 
    stopCamBtn.disabled = true;
    
    // Si estamos reconectando y falla, intentar de nuevo después de un tiempo
    if (isReconnecting) {
      setTimeout(() => startCamera(true), 2000);
    }
  }
}

async function stopCamera(){
  if(!scanning) return;
  try {
    await html5Scanner.stop(); 
    await html5Scanner.clear();
  } catch (e) {
    console.warn("Error stopping camera:", e);
  }
  scanning = false; 
  startCamBtn.disabled = false; 
  stopCamBtn.disabled = true;
  
  // Guardar estado de sesión
  saveSessionState();
  
  showLog("Cámara detenida.");
}

// -------- PDF ----------
async function exportPdf(){
  if(!history.length){alert("No hay datos");return;}
  const {jsPDF}=window.jspdf; const doc=new jsPDF();
  doc.setFontSize(14); doc.text("Historial de escaneos - Sonica",40,40);
  let y=70; doc.setFontSize(10);
  history.forEach((h,i)=>{doc.text(`${i+1}. ${h.tipo} ${h.numero} | ${formatDate(h.ts)} | ${h.duplicado?"DOBLE":"ÚNICO"}`,40,y); y+=14; if(y>780){doc.addPage();y=40;}});
  doc.save("historial-sonica.pdf");
}

// -------- Eventos ----------
loginBtn.onclick = () => {
  if(usernameInput.value.trim() === AUTH_USER && passwordInput.value.trim() === AUTH_PASS){
    loginBox.style.display = 'none'; 
    scannerArea.style.display = 'block';
    loadState(); 
    startCamera();
    
    // Guardar estado de sesión
    saveSessionState();
  } else {
    alert("Usuario o contraseña incorrectos");
  }
};

loginDemo.onclick = () => {
  usernameInput.value = AUTH_USER; 
  passwordInput.value = AUTH_PASS;
};

startCamBtn.onclick = () => startCamera(); 
stopCamBtn.onclick = stopCamera;

clearHistoryBtn.onclick = () => { 
  if(confirm("¿Borrar historial?")) {
    history = [];
    seenSet = new Set();
    saveState();
    renderHistory();
    showLog("Historial borrado.");
  }
};

exportPdfBtn.onclick = exportPdf;

toggleSoundBtn.onclick = () => {
  soundOn = !soundOn; 
  toggleSoundBtn.innerText = `Sonido: ${soundOn?"ON":"OFF"}`;
  saveSessionState();
};

logoutBtn.onclick = () => {
  if (scanning) {
    stopCamera();
  }
  clearSessionState();
  loginBox.style.display = 'block';
  scannerArea.style.display = 'none';
  usernameInput.value = '';
  passwordInput.value = '';
};

retryCameraBtn.onclick = () => {
  startCamera();
};

// Inicializar la aplicación cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
  // Cargar el estado guardado
  loadState();
});

// Guardar el estado antes de cerrar la página
window.addEventListener('beforeunload', function() {
  saveSessionState();
});
</script>
</body>
</html>
